@model VismaUtvikler.Models.Customer

@{
    ViewBag.Title = "Details";
}

<h2>Details</h2>

<div>
    <h4>Customer</h4>
    <hr />
   
    <dl class="dl-horizontal">
        <dt>
            @Html.DisplayNameFor(model => model.FirmName)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.FirmName)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.Adress)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Adress)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.PostalCode)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.PostalCode)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.PhoneNumber)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.PhoneNumber)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.FaxNumber)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.FaxNumber)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.MailAdress)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.MailAdress)
        </dd>

    </dl>
</div >
<h4>Kontakt Personer</h4>
<div id="contactPersonContent">
    <table class="table table-sm">
        <thead>
        <tr>
            <th>Fornavn</th>
            <th>Etternavn</th>
            <th>telefon nummer</th>
        </tr>
        </thead>
        <tbody id="result">
        
        </tbody>
    </table>


</div>
<p>
    @Html.ActionLink("Edit", "Edit", new { id = Model.Id }) |
    @Html.ActionLink("Back to List", "Index")
</p>
<input type="hidden" value=@Model.Id id='customerId'>


@section scripts{

    <script>
        $(document).ready(function () {
            var responsedata;

            var customerId = $('#customerId').val();
           


        $.ajax({
            url: "/api/ContactPersons/" + customerId,
                method: "GET",
                dataType: 'json'

        }).done(function (data) {
            responsedata = data;
            if (responsedata.length <2) {
                $("#contactPersonContent").html('');
                $("#contactPersonContent").append("<div class='alert alert-warning' role='alert'>'<strong>'Advarsel'</strong>' Det er ingen kontaktpersoner registret på denne kunden.</div>")
                    
            }else{
                    console.log(data);
                    $.map(data, function (post, i) {
                        console.log(post)
                        $("#result").append(
                            "<tr class='clickable-row' data-href='#'>" +

                            "<td>" + post.FirstName + " " + post.lastName + "</td>"
                            + "<td>" + post.Adress + "</td><td>" + post.lastName + "</td><td>" + post.PhoneNumber + "</td><td>" + post.PhoneNumber + "</td><td>" + post.MailAdress + "</td>" +
                           "<td><a href='/customers/Edit/" + post.Id + "'> <span class='glyphicon glyphicon-pencil'></span></a><button class='btn-link js-delete' data-customer-id=" + post.Id + ">| <span class='glyphicon glyphicon-trash'></span>|</button><a href='/customers/Details/" + post.Id + "'>Details </a></button> </td>" +
                            " </tr>"

                        )
                    }
           
                )
            }
                })



            $("#customers").on("click",".js-delete",function () {
                var button = $(this);
                //bootbx confirm er et alternativ til vanlig confirmbox
                bootbox.confirm("Er du sikker på at du vil slette denne kunden?", function(result) {
                    if (result) {

                        $.ajax({
                            url: "/api/customers/" + button.attr("data-customer-id"),
                            method: "DELETE",
                            success: function () {
                                console.log("Kunden er slettet success!!");
                                button.parents("tr").remove();
                            }
                        })

                    }
                })

            })
            $("#search").keyup(function() {
                //tømmer result tabel for innhold
                $("#result").html('');
                //plasserer verdien i søkefeltet i searchField variablen       |</button><a href='/customers/Details/" + post.Id + "'>Details </a></button>
                var searchField = $("#search").val();
                console.log(searchField);
                //lager en regular expressin variable
                var expression = new RegExp(searchField, "i");
                console.log(responsedata);

                $.each(responsedata,
                    function (key, value) {
                        console.log("Logg fra search value",value)
                        if (value.FirmName.search(expression) != -1 || value.Adress.search(expression) != -1||value.MailAdress.search(expression)!=-1) {
                            $("#result").append("<tr><td>" + value.FirmName + "</td>" +
                                "<td>" + value.Adress + "</td><td>" + value.PostalCode + "</td>" +
                                "<td>" + value.PhoneNumber + "</td><td>" + value.FaxNumber + "</td>" +
                                "<td>" + value.MailAdress + "</td> <td>" +
                                "<a href='/customers/Edit/" + value.Id + "'><span class='glyphicon glyphicon-pencil'></span> " +
                                "|</a><button class='btn-link js-delete' data-customer-id=" + value.Id +
                                ">| <span class='glyphicon glyphicon-trash'></span>  |</button>" +
                                "<a href='/customers/Details/" + value.Id + "'>Details " +
                                "</tr>")
                        }
                    })

            });



            ////Lager tabelrow til linker
            $("#customers").on('click-row.bs.table', function (e, row, $element) {
                alert("")
                window.location = $element.data('href');
            });
        });
    </script>

}
